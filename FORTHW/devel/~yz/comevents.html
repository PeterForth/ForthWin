<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
<link rel="stylesheet" href="forth.css" type="text/css">
<title>Обработка событий COM</title>
</head>

<body background="pic/grid.gif">

<h1 class=lib><u>comevents.f</u>
&nbsp;Обработка событий COM
</h1>

Расширение библиотеки <a href="automate.html">Automate</a>,
позволяющее не только управлять серверами автоматизации, но и обрабатывать 
генерируемые ими события.
</p>

<u>Connect</u> <i>( obj -- 0/errcode )</i>
<p>Подключается к объекту для обработки генерируемых им событий. Если
объект не поддерживает события, возвращается  E_NOINTERFACE.
</p>

<u>ConnectTo</u> <i>( obj zguid -- 0/errcode )</i>
<p>Подключается к интерфейсу <i>zguid</i> объекта для обработки
генерируемых событий.
</p>

<u>Disconnect</u> <i>( obj -- )</i>
<p>Отсоединяется от объекта и освобождает все ресурсы, использовавшиеся
для соединения.
</p>

<u>Hook</u> <i>( obj memid xt -- )</i>
<p>Объявляет форт-слово <i>xt</i> обработчиком события с кодом <i>memid</i>,
приходящего от объекта <i>obj</i>.
</p>

<u>Unhook</u> <i>( obj memid -- )</i>
<p>
Удаляет обработчик события с кодом <i>memid</i>, приходящего от объекта <i>obj</i>.
</p>

<u>Arg</u> <i>( n -- val/dval )</i>
<p>Выдает <i>n</i>-й аргумент обрабатываемого события как одно или два
значения на стеке и записывает его тип в <u>LAST-VALUE</u>. Работает
только в обработчике события. К первым девяти аргументам можно обращаться
проще: <u>Arg1</u> <i>( -- val/dval )</i>, <u>Arg2</u> <i>( -- val/dval)</i> и так далее.
</p>

<u>comevents-trace</u> <i>( -- a)</i>
<p>Служебная переменная. Если ее значение не равно нулю, библиотека
трассирует запросы к QueryInterface и приходящие события.
</p>

<div class="e">
<font color=gray>Пример</font>
<br>
<tt>
0 VALUE excel<br>
<br>
: OnWinResize<br>
  ." Окно с заголовком " Arg2 DUP [[ Caption ]] .ansiz release ."  изменило размер" CR<br>
;<br>
<br>
" Excel.Application" CreateObject .err TO excel<br>
excel [[ Visible = TRUE ]]<br>
excel [[ Workbooks Add ]] release<br>
excel Connect .err<br>
excel 0x612 ['] OnWinResize Hook<br>
KEY DROP \ теперь самое время вручную свернуть в Excel окно текущей таблички<br>
excel 0x612 Unhook<br>
excel Disconnect<br>
excel release<br>
</tt>
</div>

<h2>Дополнительная информация:</h2>
<p>1. Библиотека присоединяется к первому интерфейсу событий, выдаваемому
IConnectionPointContainer::EnumConnectionPoints. Для большинства объектов
этот интерфейс является единственным, а следовательно, и источником
событий по умолчанию. Если объект поддерживает более чем один источник
событий, а библиотека присоединяется не к тому, что надо, используйте
слово <u>ConnectTo</u>, позволяющее явно указать GUID исходящего
интерфейса. Явно определить источник событий по умолчанию, к сожалению,
невозможно, поскольку не все объекты поддерживают специально
предназначенные для этой цели интерфейсы IProvideClassInfo и
IProvideClassInfo2.
<p>2. Определить коды событий <i>memid</i> для различных объектов можно с
помощью программы ole2vw32.exe или напрямую подключаясь к соответствующей
библиотеке типов.


</html>