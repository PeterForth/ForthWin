<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
<link rel="stylesheet" href="forth.css" type="text/css">
<title>Управление серверами автоматизации</title>
</head>

<body background="pic/grid.gif">

<h1 class=lib><u>automate.f</u>
&nbsp;Управление серверами автоматизации
</h1>

<font size="2">
<a href="automate.html#run">1. Запуск и остановка сервера</a>
<br><a href="automate.html#methods">2. Доступ к методам и свойствам</a>
<br><a href="automate.html#foreach">3. Цикл по коллекции</a>
<br><a href="automate.html#eg">4. Примеры</a>
</font>

<br><br><br>
<p>Библиотека Automate является радикально переработанной версией библиотеки
<a href="automation.html">Automation</a>:
<ul>
<li>Упрощен синтаксис доступа к свойствам и методам сервера;
<li>Библиотека теперь может работать и в режиме интерпретации (кроме цикла
<u>FOREACH</u> ... <u>NEXT</u>);
<li>Имена части слов унифицированы с библиотекой 
<a href="../~ac/lib/win/com/com.f">com.f</a> Андрея Черезова
</ul>
<p>Все слова библиотеки работают с asciiz-строками, оканчивающимися нулем.
Слово <u>"</u>, определяющее такие строки, описано в <a href="lib/common.f">common.f</a>.
</p>

<a name=run></a>
<h1>1. Запуск и остановка сервера</h1>

<u>ComInit</u> <i>( -- error )</i>
<p>Инициализирует подсистему COM Windows в многопоточном режиме. Возвращает 0, 
если инициализация прошла успешно и код ошибки в противном случае (крайне маловероятном).
</p>

<u>ComDestroy</u> <i>( -- )</i>
<p>
Выгружает подсистему COM.
</p>

<u>CreateObject</u> <i>( ProgId -- object 0 / error)</i>
<p>
Запускает сервер автоматизации, создает объект <i>ProgId</i> и
возвращает адрес его интерфейса IDispatch.
</p>

<u>GetObject</u> <i>( ProgId -- object 0 / error)</i>
<p>
Подсоединяется к уже запущенному серверу и возвращает адрес объекта
<i>ProgId</i>.
</p>

<u>?CreateObject</u> <i>( ProgId -- object 0 / error)</i>
<p>
Пытается подсоединиться к уже запущенному серверу; если это не удается,
запускает сервер с помощью <u>CreateObject</u>.
</p>

<u>ObjectFromFile</u> <i>( filename -- object 0 / error)</i>
<p>
Запускает сервер, создавший документ <i>filename</i>, загружает
его и возвращает адрес объекта-документа.
</p>
<div class=e>
\ Запустит Word, загрузит в него "Письмо" и возвратит его адрес как объекта
<br>
<tt>" c:/Мои документы/Письмо турецкому султану.doc" ObjectFromFile</tt>
</div>

<u>release</u> <i>( object -- )</i>
<p>
Освобождает объект. Теоретически, если объект был создан с помощью
<u>CreateObject</u>, он должен выгрузиться из памяти. На практике выполнить точный
учет всех ссылок бывает затруднительно. Поэтому
рекомендуется перед вызовом <u>release</u> явно завершить работу объекта с 
помощью соответствующего метода (как правило, он называется Quit).
</p>

<a name=methods></a>
<h1>2. Доступ к методам и свойствам</h1>

Доступ к методам и свойствам объекта производится с помощью универсального 
вызова, принимающего на вход адрес объекта IDispatch и возвращающего
результат вызова метода или значение свойства, если таковые имеются.
Формально вызов выглядит следующим образом (форт-слова выделены красным,
квадратные скобки указывают, что соответствующий элемент может
отсутствовать, фигурные обозначают повторение один или более раз):
<br><br>
<b>Вызов метода/получение свойства:</b><br>
<u>[[</u> { <i>имя_метода_или_свойства</i> [<i>список_аргументов_или_индексов</i>] } [<u>*</u>] <u>]]</u>
<br><br>
<b>Установка свойства:</b><br>
<u>[[</u> { <i>имя_метода_или_свойства</i> [<i>список_аргументов_или_индексов</i>] } <u>=</u> <i>значение</i> <u>]]</u>
<p>
Универсальный вызов проходит по цепочке имен, по очереди вызывая указанные 
объекты и автоматически освобождая уже ненужные, и затем выполняет нужную
операцию, оставляя ее результат, если он есть, на стеке.
<p>
Библиотека, запрашивая сервер, одновременно устанавливает флаги "метод" и
"свойство", даже если заранее известно, что требуется вызвать метод.
Большинство серверов автоматизации распознают такую 
ситуацию и возвращают корректное значение. Меньшинство (например,
Microsoft Word) считают себя умнее программиста и выдают ошибку
DISP_E_TYPEMISMATCH (несоответствие типов). В таких случаях просто
пометьте вызов звездочкой <u>*</u> (пример смотрите в <a
href="prog/automate/word2.f">word2.f</a>, вызов метода SaveAs).

<p>Имя метода_или_свойства обычно известно на этапе компиляции и тогда оно 
задается просто строкой. Для некоторых применений (например, при 
использовании протокола SOAP) имена заранее неизвестны и получаются только 
в ходе исполнения программы. В таких случаях можно использовать произвольное выражение, 
возвращающее форт-строку (a n), заключив его в слова <u>{</u> и <u>}</u>.
<div class=e>
<tt>word [[ Name ]] .ASCIIZ</tt>
<br>эквивалентно
<br>
<tt>word [[ { S" Name" } ]] .ASCIIZ</tt>
</div>
</p>

<b>Список_аргументов</b> представляет собой список значений, разделенных
запятыми:
<br><u>(</u> <i>значение</i> <u>,</u> <i>значение</i> <u>,</u> <i>значение</i> ...<u> )</u>
<p>Тип значения определяется следующим образом:
<ul>
<li>любое выражение, оставившее на стеке ровно одно значение, считается
принадлежащим типу <b>_cell</b>;
<li>строковые литералы выделяются кавычками и выглядят традиционно:
<i>"&nbsp;&nbsp;Example"</i>;
<li>пустая строка обозначается словом <u>""</u>;
<li>выражения, возвращающие строки Форта в формате ( -- a u) должны
помечаться словом <u>STRING</u> <i>( a u -- )</i> (при этом u не должно быть больше 255);
<li>выражения, возвращающие строки, заканчивающиеся нулем ( -- z), должны
помечаться словом <u>ASCIIZ</u> <i>( z -- )</i>;
<li>логические значения задаются словами <u>TRUE</u> и <u>FALSE</u>;
<li>выражения, возвращающие объекты любого вида, в том числе IDispatch,
отмечаются словом <u>OBJECT</u> <i>( obj -- )</i>. Смотрите пример в <a href="prog/automate/shell2.f">shell2.f</a>;
<li>даты-литералы можно задавать строковыми литералами, преобразуя их
словом <u>>DATE</u> <i>( z _str --)</i>. Например: <i>" 26.08.72" >DATE</i>;
<li>целые числа преобразуются в тип "валюта" (<b>_currency</b>) словом
<u>$</u> <i>( n -- )</i>. Например: <i>15 $</i>;
<li><u>NIL</u> обозначает пропущенный аргумент; если сервер рассчитан на это,
он подставит какое-либо значение по умолчанию.
<li>любые другие выражения должны возвращать два или три числа на стеке.
Верхнее считается типом, а оставшиеся - значением аргумента. Если
возвращается больше, чем три числа, вызывается ошибка DISP_E_BADVARTYPE
(неправильный тип переменной).
</ul>
<p>Внимание: глубина стека в точке, в которой вычисляются значения, неизвестна и
может меняться от вызова к вызову. Поэтому передавать значения через стек
невозможно. Пользуйтесь стеком возвратов, переменными или другими
подходящими способами.

<p>
Аргументы для вызова любого метода имеют естественный порядок - такой, 
как описан в документации на объект.
</p>

<div class=e>
Например, метод Microsoft Word <i>OnTime</i> требует списка аргументов
(When, Name, Tolerance), где When и Name - строка, Tolerance - целое число.
Тогда вызов метода может быть, например, таким:
<br><br>
<tt>
[[ OnTime ( " 12:00" , " WakeUp()" , 0 ) ]]
</tt>
</div>

<p>
Результат, возвращенный методом, или значение соответствующего
свойства возвращаются словом <u>]]</u>, а тип значения записывается в
value-переменную <u>LAST-TYPE</u>. Значение может
занимать одну или две ячейки, в зависимости от типа. Определены следующие типы:
<br><br>
<table width=100%>

<tr>

<td width=10%>
<tt>_empty</tt>

<td width=30%>
Нет значения

<td width=10%>
<tt>_char, _ui1</tt>
<td width=30%>
Байт

<tr>

<td width=10%>
<tt>_int, _cell</tt>
<td width=30%>
Целое число

<td width=10%>
<tt>_word, _i2</tt>
<td width=30%>
Двухбайтовое слово

<tr>

<td width=10%>
<tt>_float, _r4</tt>
<td width=30%>
Число с плавающей точкой

<td width=10%>
<tt>_double, _r8</tt>
<td width=30%>
Число с плавающей точкой двойной длины (две ячейки)

<tr>
<td width=10%>
<tt>_bool</tt>
<td width=30%>
Логическое значение TRUE/FALSE

<td width=10%>
<tt>_currency </tt>
<td width=30%>
Денежный формат (две ячейки)

<tr>

<td width=10%>
<tt>_date</tt>
<td width=30%>
Дата (две ячейки)

<td width=10%>
<tt>_str</tt>
<td width=30%>
asciiz-строка в кодировке ANSI

<tr>

<td width=10%>
<tt>_obj</tt>
<td width=30%>
Объект, имеющий интерфейс автоматизации (IDispatch)

<td width=10%>
<tt>_unk</tt>
<td width=30%>
Объект с интерфейсом IUnknown

</table>

<p>Память под строки, возвращаемые как свойство или результат метода,
выделяется словом <u>ALLOCATE</u>, поэтому после использования ее нужно
освободить словом <u>FREE</u>. Возвращаемые объекты с типом <i>_obj</i> и
<i>_unk</i> после использования требуется освободить словом <u>release</u>.

<p>Если вызванный метод не возвращает никакого значения или производилась установка свойства,
<u>]]</u> не возвращает ничего, а в <u>LAST-TYPE</u> записывается тип
<b>_empty</b>. Будьте осторожны: многие сервера (в частности, Excel) имеют 
привычку возвращать различные значения, даже если в документации сказано,
что значения нет. Например, <i>Range.Select</i> и многие другие методы
Excel возвращают логическое значение, очевидно, обозначающее успех или
неуспех метода. С другой стороны, такой невинный вызов, как получение
значения ячейки в таблице Excel, может вернуть значение любого типа или не 
вернуть никакого, если ячейка была пуста.

</p>
<u>?AUERROR</u> вектор
<br><i>( 0 / error -- )</i>

<p>
В этом векторе хранится адрес обработчика ошибок, которые могут произойти при
доступе к объекту. На стеке слову передается 0, если все прошло успешно или код ошибки <i>error</i>. Стандартный обработчик выдает информацию об ошибке на
консоль и вызывает <u>ABORT</u>.
</p>

<a name=foreach></a>
<h1>3. Цикл по коллекции</h1>

<i>( object -- )</i> <u>FOREACH</u> .. <u>NEXT</u>

<p>
Цикл по коллекции object. Если переданный объект не является коллекцией, цикл
не выполняется ни разу. <u>FOREACH</u>..<u>NEXT</u> оставляет на стеке возвратов некоторые
данные, поэтому внутри цикла необходимо соблюдать те же ограничения, что и
внутри цикла <u>DO</u>..<u>LOOP</u>.
</p>

<u>OBJ-I</u> <i>( -- val)</i>
<p>
Выдает текущий объект из коллекции и записывает в <u>LAST-TYPE</u> его тип. Объект после
использования следует освободить словом <u>release</u>.
</p>

<div class=e>
<tt>documents FOREACH
<br>  OBJ-I DUP [[ Name ]] DUP .ASCIIZ FREEMEM</tt> \ используем полученную строку...
<br>  <tt>release</tt> \ освобождаем ссылку, выданную OBJ-I
<br><tt>  OBJ-I DUP [[ Creator ]] DUP .ASCIIZ FREEMEM
<br>  release </tt>\ освобождаем и эту ссылку
<br>  \ в общем, если объект будет использоваться несколько раз, проще один раз
<br>  \ вызвать OBJ-I, сохранить ссылку где-нибудь в переменной, а потом освободить
<br><tt>NEXT
</tt></div>

<u>OBJ-J</u> <i>( -- val)</i>
<p>
Текущий объект объемлющего цикла <u>FOREACH</u>..<u>NEXT</u>. Аналог <u>J</u>.
</p>

<u>LEAVE-FOREACH</u>
<p>
Прекращает работу цикла <u>FOREACH</u>..<u>NEXT</u>. Аналог <u>LEAVE</u>.
</p>

<u>collection?</u> <i>( object -- ? )</i>
<p>
Проверяет, является ли переданный объект коллекцией.
</p>

<a name=eg></a>
<h1>4. Примеры</h1>

<table border=0 align=left width=50%>
<tr align=center>
<td>
<a href="prog/automate/word2.f">
<img src="pic/spf.gif" border=0 alt="word.f"></a>
<td>
<a href="prog/automate/excel2.f">
<img src="pic/spf.gif" border=0 alt="excel.f"></a>
<td>
<a href="prog/automate/shell2.f">
<img src="pic/spf.gif" border=0 alt="shell.f"></a>
<tr align=center>
<td>
<a href="prog/automate/word2.f">word2.f</a>
<td>
<a href="prog/automate/excel2.f">excel2.f</a>
<td>
<a href="prog/automate/shell2.f">shell2.f</a>
</table>

</html>