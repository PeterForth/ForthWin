<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
<link rel="stylesheet" href="forth.css" type="text/css">
<link rel="stylesheet" href="version.css" type="text/css">
<title>XMENU - секретное меню</title>
</head>

<body background="pic/grid.gif">

<font size=5>XMENU
<br>секретное меню<br>
</font>


<h1>Смысл программы</h1>
<p>Если работать на компьютере профессионально, часто приходится выполнять 
одни и те же последовательности действий. Естественно, любой программист в 
соответствии с принципом "Машина должна работать, а человек - думать",
поспешит такие повторяющиеся действия как-то автоматизировать. Надо
только придумать, как их запускать. С одной стороны, они должны быть
всегда под рукой, с другой стороны - не должны все время маячить на
экране. Этим условиям удовлетворяет только системная панель. Осталось
написать программу, которая будет садиться в системную панель и
показывать оттуда меню.

<h1>Запуск и использование</h1>
<p>Параметров командной строки у XMENU нет, а текущие настройки она берет 
из двух файлов, находящихся в текущем каталоге. Первым читается файл с 
именем XMENU.CFG. В нем хранятся настройки, общие для всех пользователей.  
Затем читается файл с названием <имя пользователя>.cfg, содержащий 
настройки для конкретного пользователя. Один из этих файлов или сразу оба 
могут отсутствовать. Настройка работы программы и меню осуществляется с 
помощью операторов, описанных ниже.
<p>Программа позволяет задавать два меню, вызывающееся по левой и по 
правой кнопке мыши соответственно.

<h1>Настройки программы</h1>

<u>ДОБАВИТЬ filename</u><i> ( ->eol; -- ) </i>
<p>Читается и интерпретируется содержимое указанного файла</p>

<u>ИКОНКА filename</u><i> ( ->eol; -- ) </i>
<p>Стандартная иконка программы, изображающая синюю мышку, заменяется на указанную.</p>

<u>ПОДСКАЗКА tooltip</u><i> ( ->eol; -- ) </i>
<p>Стандартная подсказка программы "Секретное меню" заменяется на указанную.</p>

<u>\</u><i> ( ->eol; -- ) </i>
<p>Все до конца строки считается комментарием</p>

<u>МАКРО</u> macro text <i>( -- )</i>
<p>Определить макрос macro. Использовать его можно в командах 
<u>ЗАПУСТИТЬ</u>, <u>КАТАЛОГ</u> и в командах вызова скрипта. Вместо 
выражения <i>[macro]</i> будет подставлен 
<i>text</i>. В Форт-программах, стоящих между <u>ФОРТ:</u> и
<u>ФОРТ;</u> развернуть макрос можно с помощью слова <u>macro</u> <i>( zmacro -- ztext)</i>
</p>

<u>СКРИПТ</u> script program <i>( -- )</i>
<p>Определить команду <i>script</i>, вызывающую программу <i>program</i>. 
Если в имени программы есть пробелы, все имя необходимо заключить в 
кавычки</p> 

<u>ЗАПОМНИТЬ</u> filename <u>КАК</u> name<i> ( -- )</i>
<p>Прочитать файл иконки <i>filename</i> и запомнить иконку под именем <i>name</i>. 
Если в имени файла или иконки есть пробелы, все имя необходимо заключить в 
кавычки. Запомненную иконку можно затем использовать при вызове программы через внешний канал.</p> 

<h1>Настройки меню</h1>

<u>ЛЕВОЕ-МЕНЮ</u> <i>( -- )</i>
<p>Все определения меню, указанные ниже, будут относиться к меню, 
вызываемому по ЛЕВОЙ клавише мыши.
</p>

<u>ПРАВОЕ-МЕНЮ</u> <i>( -- )</i>
<p>Все определения меню, указанные ниже, будут относиться к меню, 
вызываемому по ПРАВОЙ клавише мыши. Если после интерпретации всех файлов 
правое меню окажется пустым, в него автоматически будут добавлены три 
пункта: <u>ПУНКТ-ПЕРЕЧИТАТЬ</u>, <u>ПУНКТ-О-ПРОГРАММЕ</u>, <u>ПУНКТ-ВЫХОД</u>.
</p>


<u>ПРАВОЕ-МЕНЮ-ПО-ЛЕВОМУ</u> <i>( -- )</i>
<p>После вызова этой команды правое меню будет уничтожено, а нажатие и 
левой, и правой кнопок мыши будут вызывать одно и то же левое меню.
</p>

<u>>></u> item |icon<i> ( ->"|" ->eol; -- ) </i>
<p>Пункт меню с текстом <i>item</i> и иконкой <i>icon</i>. В следующей строке записывается
действие, которые должно выполняться при выборе этого пункта. Таких
действий всего три - запустить внешнюю программу, запустить скрипт или выполнить программу
на Форте.
</p>

<u>ЗАПУСТИТЬ</u> command-string<i> ( ->eol; -- ) </i>
<p>Открыть указанный файл. У файла может быть командная строка <i>command-string</i>. 
Можно указывать не только исполняемые файлы, но и любые другие. 
Исполняемые файлы будут действительно запущены, другие - открыты согласно 
зарегистрированному расширению.
Здесь стоит сказать пару слов о полных именах файлов, в которых есть пробелы. Такие 
файлы нужно заключать в кавычки, однако не все, а только первый из них. 
Соответственно, для команды <u>ЗАПУСТИТЬ</u> в кавычках должно стоять
только имя запускаемой программы, а кавычки вокруг аргументов должны быть 
только в том случае, если их понимает вызываемая программа. 
</p>

<u>ФОРТ:</u><i> ( -- ) </i>
<p>Начать определение программы на Форте, которая будет выполнена при
выборе пункта меню. Делать эта программа может все, что угодно. Для вывода 
на экран пользуйтесь словами <u>err</u> <i>( z -- )</i> и <u>msg</u> <i>(
z -- )</i>. На выходе программа должна оставить стек в том же состоянии, в 
каком он был на входе, иначе (под Windows NT) произойдет сбой общей защиты.
</p>

<u>ФОРТ;</u><i> ( -- ) </i>
<p>Закончить определение программы на Форте</p>

<u>---</u><i> ( -- ) </i>
<p>Поставить в меню горизонтальный разделитель</p>

<u>МЕНЮ </u>submenu |icon<i> ( ->"|"; ->eol; -- ) </i>
<p>Начать вложенное меню, присвоив ему текст <i>submenu</i> и иконку <i>icon</i></p>

<u>КОНЕЦ-МЕНЮ</u><i> ( -- ) </i>
<p>Закончить вложенное меню</p>

<u>КАТАЛОГ</u> dir<i> ( ->eol; -- )</i>
<p>Создать пункт меню, который будет показывать указанный каталог. 
Ограничить список показываемых файлов определенными масками можно с помощью слова <u>ФИЛЬТР</u></p>

<u>ПАПКА</u> dir<i> ( ->eol; -- )</i>
<p>То же, что и <u>КАТАЛОГ</u></p>

<u>ФИЛЬТР</u> filter <i>( ->bl; -- )</i>
<p>Ограничить показ следующего каталогами указанными масками. Маски разделяются точкой с запятой</p>

<u>ПРОГРАММЫ</u> <i>( -- )</i>
<p>Показать список программ для текущего пользователя (точнее, список 
общих программ и список программ пользователя)</p> 

<u>МОИ-ДОКУМЕНТЫ</u> <i>( -- )</i>
<p>Показать каталог документов текущего пользователя</p>

<u>ПРОГРАММА</u> prog <i>( ->bl; -- )</i>
<p>Показать содержимое пункта меню "Программы", соответствующий указанному имени</p>

<u>ПУНКТ-ПЕРЕЧИТАТЬ</u> <i>( -- )</i>
<p>Стандартный пункт <b>Перечитать файл </b> - читает заново файлы настройки, 
соответственно переустанавливая все элементы меню и другие настройки
</p>

<u>ПУНКТ-О-ПРОГРАММЕ</u> <i>( -- )</i>
<p>Стандартный пункт <b>О программе </b>- показывает информацию об авторе
</p>

<u>ПУНКТ-О-ПРОГРАММЕ</u> <i>( -- )</i>
<p>Стандартный пункт <b>Выход </b>- выгружает программу из памяти.
</p>

<h1>Управление через внешний канал</h1>
<p>Программа постоянно прослушивает широковещательный <a 
href="channel.html">канал</a> с именем <i>XMENU</i> и выполняет команды, 
присланные по этому каналу. Таким образом можно управлять программой из 
внешних программ. При отсылке команды на нее реагируют все запущенные копии 
XMENU, <i>даже находящиеся в разных терминальных сессиях.</i> Распознаются следующие команды:
</p>

<u>"</u> <i>( ->"; -- )</i>
<p>Компилирует asciiz-строку.
</p>

<u>new-tooltip</u> <i>( z -- )</i>
<p>Устанавливает новую подсказку.
</p>

<u>msgbox</u> <i>( ztitle ztext -- )</i>
<p>Заставляет программу показать окно сообщения с указанным заголовком и текстом.
</p>

<u>popup-info</u> <i>( ztitle ztext ms -- )</i>
<p>Заставляет программу показать всплывающую информацию. Информация будет 
находиться на экране указанное число миллисекунд (но не меньше 10 сек. и не 
больше 30 сек.).
</p>

<u>new-icon</u> <i>( zicon ms -- )</i>
<p>То же, что и <u>new-icon-by-handle</u>, но иконка представляется своим 
именем, запомненным по <u>ЗАПОМНИТЬ ... КАК</u>. Такой вызов будет 
работать между терминальными сессиями, но в файле конфигурации XMENU 
необходимо заранее задать иконки, которые будут использоваться.
</p>

<u>make-mouse-blink</u> <i>( -- )</i>
<p>Заставляет мышку мигнуть.
</p>

<u>new-icon-by-handle</u> <i>( hicon ms -- )</i>
<p>Устанавливает новую иконку на <i>ms</i> миллисекунд. Если ms = 0, 
иконка устанавливается навсегда. <i>hicon</i> - это дескриптор иконки, его 
можно передать как число. Предполагается, что вызывающая программа сама 
прочитает нужные ей иконки и передаст в XMENU только дескриптор. Это можно 
сделать, если вызывающая программа и XMENU работают <b>в одной и той же 
терминальной сессии</b>.
</p>

<u>((</u> <i>( -- )</i>
<p>Начинает определение блока данных на стеке.
</p>

<u>))</u> <i>( ... -- ... block)</i>
<p>Заканчивает определение блока данных на стеке.
</p>

<u>animate-icon</u> <i>( ... block -- )</i>
<p>Демонстрирует анимацию иконки в системном лотке. Блок данных должен 
состоять из пар (имя иконки, время показа в мс).
</p>

<code>
(( " ic1" 200 " ic2" 200 " ic3" 200 )) animate-icon
</code>

<h1>Пример (можно скачать <a href="prog/xmenu/xmenu.cfg"><font color=red>отсюда</font></a>)</h1>

<div><tt>
<br>\ Пример файла XMENU.CFG
<br>
<br>МАКРО office с:\microsoft office\office\
<br>СКРИПТ ПЕРЛ d:\perl\bin\perl.exe
<br>
<br>>> Редактор WORD |open2.ico
<br>&nbsp;&nbsp;&nbsp;ЗАПУСТИТЬ "[office]winword.exe"
<br>---
<br>МЕНЮ Пример вложенного меню  |recycle.ico
<br>
<br>>> Привет
<br>&nbsp;&nbsp;&nbsp;ФОРТ:
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" Привет всем!!!" msg
<br>&nbsp;&nbsp;&nbsp;ФОРТ;
<br>
<br>>> Программа на Перле
<br>&nbsp;&nbsp;&nbsp;ПЕРЛ d:\prog.pl
<br>
<br>КОНЕЦ-МЕНЮ
<br>---
<br>>> DIR C:
<br>&nbsp;&nbsp;&nbsp;ЗАПУСТИТЬ cmd.exe /cdir c: /P
<br>
<br>---
<br>>> Тексты моих программ 
<br>&nbsp;&nbsp;&nbsp;ФИЛЬТР *.f;*.spf КАТАЛОГ d:\spf\forth
<br>
<br>>> Программы
<br>&nbsp;&nbsp;&nbsp;ПРОГРАММЫ
<br>
<br>>> Мои документы
<br>&nbsp;&nbsp;&nbsp;МОИ-ДОКУМЕНТЫ
<br>
<br>>> Папка Фара
<br>&nbsp;&nbsp;&nbsp;ПРОГРАММА Far manager
</tt></div>

<h1>Изменения по версиям</h1>

<h2 class=version>1.30</h2>
<b class=v>+</b> <u>ИКОНКА, ПОДСКАЗКА, ПУНКТ-..., ДОБАВИТЬ, ЛЕВОЕ-МЕНЮ, 
ПРАВОЕ-МЕНЮ, ПРАВОЕ-МЕНЮ-ПО-ЛЕВОМУ, ЗАПОМНИТЬ КАК</u> 
<br>
<b class=v>+</b> Управление через внешний канал
<br><b class=v>+</b> Второй файл инициализации по имени 
пользователя
<br><b class=v>-</b> Устранены утечки памяти и системных объектов при 
вызове каталогов и перечитывании файлов конфигурации

<h2 class=version>1.20</h2>
<b class=v>+</b> <u>КАТАЛОГ, ПАПКА, ФИЛЬТР, ПРОГРАММЫ, МОИ-ДОКУМЕНТЫ, 
ПРОГРАММА</u> 

<h2 class=version>1.13</h2>
<b class=v>+</b> <u>ЗАПУСТИТЬ</u> и <u>СКРИПТ</u> выставляют своим пунктам иконки по 
умолчанию.
<br>

<b class=v>*</b> Диалоговое окно диагностики ошибок расширено и исправлена его работа.
<h2 class=version>1.12</h2>
<b class=v>-</b> исправлена ошибка: программа слетала под NT, если после выхода из 
обработчика меню на стеке что-то оставалось

<h2 class=version>1.11</h2>
<b class=v>*</b> В Эксплорере показывается правильная иконка

<h2 class=version>1.10</h2>
<b class=v>*</b> Программы и скрипты запускаются в их каталоге
<br><b class=v>+</b> СКРИПТ
<br><b class=v>+</b> МАКРО
<br><b class=v>+</b> иконки в менюшках

<h2 class=version>1.02</h2>
<b class=v>-</b> Исправлен тонкий и неповторяемый сознательно глюк: меню появляется
и тут же исчезает. Оказывается, перед показом меню надо назначать окну
передний план, а после TrackPopupMenu специально посылать окну пустое сообщение,
Подробности см. в MSDN

<h2 class=version>1.01</h2>
<b class=v>*</b> Добавлен флаг tpm_returncmd, дабы не извращаться с сообщениями wm_command

</html>