<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
<link rel="stylesheet" href="forth.css" type="text/css">
<title>Управление объектами ActiveX</title>
</head>

<body background="pic/grid.gif">

<h1 class=lib><u>automation.f</u>
&nbsp;Управление объектами ActiveX
</h1>

<font size=big color="#FF0000">Библиотека устарела. Используйте взамен <a
href="automate.html">Automate</a>.
</font>

<br><br>

<font size="2">
<a href="automation.html#run">1. Запуск и остановка серверов автоматизации</a>
<br><a href="automation.html#coloncolon">2. :: - Универсальный вызов</a>
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="automation.html#args">2.1. Аргументы и результаты</a>
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="automation.html#arglist">2.2. Список аргументов</a>
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="automation.html#call">2.3. Вызов свойств и методов объектов</a>
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="automation.html#error">2.4. Обработка ошибок</a>
<br><a href="automation.html#foreach">3. FOREACH..NEXT - Цикл по коллекции</a>
<br><a href="automation.html#base">4. Базовые слова</a>
<br><a href="automation.html#eg">5. Примеры</a>
</font>

<br><br><br>
Все слова библиотеки работают с asciiz-строками, оканчивающимися нулем.
Слово <u>"</u>, определяющее такие строки, описано в <a href="lib/common.f">common.f</a>.
</p>

<a name=run></a>
<h1>1. Запуск и остановка серверов автоматизации</h1>

<u>COM-init</u> <i>( -- error )</i>
<p>Инициализирует подсистему COM Windows. Возвращает 0, если инициализация
прошла успешно и код ошибки в противном случае (крайне маловероятном).
</p>

<u>COM-destroy</u> <i>( -- )</i>
<p>
Выгружает подсистему COM.
</p>

<u>create-object</u> <i>( classname -- object 0 / error)</i>
<p>
Запускает сервер автоматизации, создает объект класса <i>classname</i> и
возвращает адрес его интерфейса IDispatch.
</p>

<u>get-object</u> <i>( classname -- object 0 / error)</i>
<p>
Подсоединяется к уже запущенному серверу и возвращает адрес объекта класса
<i>classname</i>.
</p>

<u>?create-object</u> <i>( classname -- object 0 / error)</i>
<p>
Пытается подсоединиться к уже запущенному серверу; если это не удается,
запускает сервер с помощью <u>create-object</u>.
</p>

<u>object-from-file</u> <i>( filename -- object 0 / error)</i>
<p>
Запускает сервер, создавший документ <i>filename</i>, загружает
его и возвращает адрес объекта-документа.
</p>
<div class=e>
\ Запустит Word, загрузит в него "Письмо" и возвратит его адрес как объекта
<br>
<tt>" c:/Мои документы/Письмо турецкому султану.doc" object-from-file</tt>
</div>

<u>release</u> <i>( object -- )</i>
<p>
Освобождает объект. Теоретически, если объект был создан с помощью
<u>create-object</u>, он должен выгрузиться из памяти. На практике, по 
крайней мере на моей машине, это происходит не всегда. Поэтому
рекомендуется перед вызовом <u>release</u> явно завершить работу объекта с 
помощью соответствующего метода (как правило, он называется Quit).
</p>

<a name=coloncolon></a>
<h1>2. <u>::</u> - Универсальный вызов</h1>

<a name=args></a>
<h2>2.1. Аргументы и результаты</h2>
Методы объектов используют в качестве аргументов и возвращают как
результат пары вида <i>значение тип</i>. Значение может
занимать одну или две ячейки, в зависимости от типа. В библиотеке
определены следующие типы:
<br><br>
<table width=100%>

<tr>

<td width=10%>
<tt>_empty</tt>

<td width=30%>
Нет значения

<td width=10%>
<tt>_char, _ui1</tt>
<td width=30%>
Байт

<tr>

<td width=10%>
<tt>_int, _cell</tt>
<td width=30%>
Целое число

<td width=10%>
<tt>_word, _i2</tt>
<td width=30%>
Двухбайтовое слово

<tr>

<td width=10%>
<tt>_float, _r4</tt>
<td width=30%>
Число с плавающей точкой

<td width=10%>
<tt>_double, _r8</tt>
<td width=30%>
Число с плавающей точкой двойной длины (две ячейки)

<tr>
<td width=10%>
<tt>_bool</tt>
<td width=30%>
Логическое значение TRUE/FALSE

<td width=10%>
<tt>_currency </tt>
<td width=30%>
Денежный формат (две ячейки)

<tr>

<td width=10%>
<tt>_date</tt>
<td width=30%>
Дата (две ячейки)

<td width=10%>
<tt>_str</tt>
<td width=30%>
asciiz-строка в кодировке ANSI

<tr>

<td width=10%>
<tt>_obj</tt>
<td width=30%>
Объект, имеющий интерфейс автоматизации (IDispatch)

<td width=10%>
<tt>_unk</tt>
<td width=30%>
Объект с интерфейсом IUnknown

</table>

<br>
Память под строки, возвращаемые как свойство или результат метода,
выделяется словом <u>ALLOCATE</u>, поэтому после использования ее нужно
освободить словом <u>FREE</u>. Возвращаемые объекты с типом <i>_obj</i> и
<i>_unk</i> после использования требуется освободить словом <u>release</u>.

<a name=arglist></a>
<h2>2.2. Список аргументов</h2>

<u>arg()</u> <i>( -- arglist )</i>
<p>
Пустой список аргументов.
</p>

<u>arg(</u> <i>( -- -1)</i>
<p>
Начало списка аргументов.
</p>

<u>)arg</u> <i>( -1 val type val type ... -- arglist )</i>
<p>
Конец списка аргументов. Собирает все аргументы, хранящиеся на стеке, и
возвращает адрес списка, пригодного для передачи методу. Стоит отметить,
что аргументы для вызова любого метода имеют естественный порядок - такой, 
как описан в документации на объект.
</p>

<div class=e>
Например, метод Microsoft Word <i>OnTime</i> требует списка аргументов
(When, Name, Tolerance), где When и Name - строка, Tolerance - целое число.
Тогда список аргументов для вызова метода может быть, например, таким:
<br><br>
<tt>
arg( " 12:00" _str&nbsp;&nbsp;" WakeUp()" _str&nbsp;&nbsp;0 _int )arg
</tt>
</div>

<a name=call></a>
<h2>2.3. Вызов свойств и методов объектов</h2>

<u>::</u> <i>( [val type] arglist object -- [val type] ; ->eol )</i>
<p>
Читает все до конца текущей строки, делает разбор полученного выражения и
вызывает соответствующий метод или функцию. Работу слова удобнее всего
проиллюстрировать на примерах.
</p>

<div class=e>
\ Вызов метода, не возвращающего результат
<br>\  excel.Quit
<br><tt>arg() excel :: Quit</tt>
<br>
<br>\ Вызов метода, возвращающего результат
<br>\  = shell.NameSpace(17)
<br><tt>arg( 17 _int )arg shell :: NameSpace > </tt>
<br>
<br>\ Получение свойства
<br>\ = excel.Visible
<br><tt>excel :: Visible @</tt>
<br>
<br>\ Установка свойства
<br>\ excel.Visible = true
<br><tt>TRUE _bool excel :: Visible !</tt>
<br>
<br>\ Получение индексированного свойства
<br>\ = excel.Range[A1:A3]
<br><tt>excel :: Range ["A1:A3"] @</tt>
<br>
<br>\ Установка индексированного свойства
<br>\  excel.ActiveSheet.Cells[1,1].Value = 3
<br><tt>3 _int excel :: ActiveSheet Cells [1,1] Value !</tt>
</div>

<p>
Таким образом, <u>::</u> последовательно опускается по иерархии объектов и выполняет
операцию, обозначенную последним символом: вызывает метод, не возвращающий
результат (нет символа), метод, возвращающий результат (<i>></i>), запрашивает
свойство (<i>@</i>) или устанавливает свойство (<i>!</i>), затем вызывает для проверки
успешности операции <u>?OLE-ERROR</u>. При вызове метода должен обязательно
присутствовать список аргументов. Если аргументов нет - используйте
<u>arg()</u>.
<p>
Индексы могут быть любой размерности. В качестве индекса могут использоваться
строки (заключены в кавычки "...") или выражения Форта, возвращающие ровно
одно число.
</p>

<div class=e>
<tt>5 CONSTANT five
<br>...
<br>... [2 2*,"hello",five] ... эквивалентно [4,"hello",5]
</tt>
</div>

<p>
В строках и в выражениях запрещено употреблять правую квадратную
скобку, в строках - кавычку, в выражениях - запятую. Кроме того, выражения не должны начинаться с кавычки. В
случае крайней необходимости можно указать код нужного символа.
</p>

<div class=e>
<tt>["[a\93"] эквивалентно ["[a]"]</tt>
</div>

<a name=error></a>
<h2>2.4. Обработка ошибок</h2>

<u>?OLE-ERROR</u> вектор
<br><i>( 0 / argnumber error -- )</i>

<p>
Если слова из библиотеки получают неправильные параметры, дело нередко
заканчивается общим сбоем защиты где-то в недрах Windows и выдачей дампа. В
менее фатальных случаях <u>::</u> после выполнения заказанных методов или
свойств вызывает слово, адрес которого хранится в векторе <u>?OLE-ERROR</u>. На стеке
передается 0, если все прошло успешно или код ошибки <i>error</i> и номер аргумента <i>argnumber</i>,
при исполнении которого произошла ошибка. Под аргументами <u>::</u> понимаются
имена вложенных объектов. Они нумеруются слева
направо, начиная с нуля. Стандартный обработчик выдает информацию об ошибке на
консоль и вызывает <u>ABORT</u>.
</p>

<u>OLE-ERROR</u> <i>( -- description errcode)</i>
<p>
Если слово <u>::</u> вернуло код ошибки disp_e_exception (0x80020009), которым сервер
сообщает об ошибке при выполнении запроса,  имеется возможность получить
дополнительную информацию. <u>OLE-ERROR</u> возвращает уточненный код
ошибки и ее описание в виде текстовой строки (которую, кстати, нужно освободить после
использования словом <u>FREE</u>) или 0, если сервер не предоставил такого описания.
Подобно GetLastError, <u>OLE-ERROR</u> очищает информацию об ошибке после своего
вызова.
</p>

<a name=foreach></a>
<h1>3. <u>FOREACH</u>..<u>NEXT</u> - Цикл по коллекции</h1>

<i>( object -- )</i> <u>FOREACH</u> .. <u>NEXT</u>

<p>
Цикл по коллекции object. Если переданный объект не является коллекцией, цикл
не выполняется ни разу. <u>FOREACH</u>..<u>NEXT</u> оставляет на стеке возвратов некоторые
данные, поэтому внутри цикла необходимо соблюдать те же ограничения, что и
внутри цикла <u>DO</u>..<u>LOOP</u>.
</p>

<u>OBJ-I</u> <i>( -- val type)</i>
<p>
Выдает текущий объект из коллекции и его тип - <i>_obj</i>. Объект после
использования следует освободить словом <u>release</u>.
</p>

<div class=e>
<tt>documents FOREACH
<br>  OBJ-I DROP DUP :: Name @
<br>  release</tt> \ освобождаем ссылку, выданную OBJ-I и используем полученную строку...
<br><tt>  OBJ-I DROP DUP :: Creator @
<br>  release </tt>\ освобождаем и эту ссылку
<br>  \ в общем, если объект будет использоваться несколько раз, проще один раз
<br>  \ вызвать OBJ-I, сохранить ссылку где-нибудь в переменной, а потом освободить
<br><tt>NEXT
</tt></div>

<u>OBJ-J</u> <i>( -- val type)</i>
<p>
Текущий объект объемлющего цикла <u>FOREACH</u>..<u>NEXT</u>. Аналог <u>J</u>.
</p>

<u>LEAVE-FOREACH</u>
<p>
Прекращает работу цикла <u>FOREACH</u>..<u>NEXT</u>. Аналог <u>LEAVE</u>.
</p>

<u>collection?</u> <i>( object -- ? )</i>
<p>
Проверяет, является ли переданный объект коллекцией.
</p>

<a name=base></a>
<h1>4. Базовые слова</h1>

Вообще говоря, описанного выше слова <u>::</u> вполне достаточно для
управления серверами. Однако для каких-то тонких операций (например, для
получения свойств, индексированных датами или вещественными числами - вдруг в
Редмонде и до этого додумаются), возможно, понадобится осуществлять операции
на более низком уровне, получая свойства или вызывая методы по одному с
помощью описанных ниже слов. Под <i>errarg#</i>, которое они возвращают в
случае ошибки, понимается номер ошибочного аргумента <b>из списка
аргументов</b>.
</p>

<u>PROP@</u> <i>( name object -- val type 0 / errarg# error )</i>
<p>
Прочитать свойство <i>name</i> объекта <i>object</i>.
</p>

<u>PROP[]@</u> <i>( arglist name object -- val type 0 / errarg# error )</i>
<p>
Прочитать индексированное свойство. <i>arglist</i> - список индексов.
</p>
<div class=e>
<tt>0 VALUE activesheet
<br>...
<br>arg( 1 _int 1 _int )arg " Cells" activesheet PROP[]@
</tt></div>

<u>PROP!</u> <i>( val type name object -- errarg# error / 0 )</i>
<p>
Записать новое значение <i>val</i> типа <i>type</i> в свойство <i>name</i>.
</p>

<u>PROP[]!</u> <i>( val type arglist name object -- errarg# error / 0 )</i>
<p>
Записать новое значение индексированного свойства <i>name</i>. <i>arglist</i>
- список индексов.
</p>

<u>METHOD</u> <i>( arglist name object -- errarg# error / 0 )</i>
<p>
Вызвать метод <i>name</i>, не возвращающий результатов.
</p>

<u>METHOD></u> <i>( arglist name object -- val type 0 / errarg# error )</i>
<p>
Вызвать метод <i>name</i>, возвращающий результат.
</p>

<a name=eg></a>
<h1>5. Примеры</h1>

<table border=0 align=left width=50%>
<tr align=center>
<td>
<a href="prog/automation/word.f">
<img src="http://www.forth.org.ru/~yz/load.gif" border=0 alt="word.f"></a>
<td>
<a href="prog/automation/excel.f">
<img src="http://www.forth.org.ru/~yz/load.gif" border=0 alt="excel.f"></a>
<td>
<a href="prog/automation/shell.f">
<img src="http://www.forth.org.ru/~yz/load.gif" border=0 alt="shell.f"></a>
<tr align=center>
<td>
<a href="prog/automation/word.f">word.f</a>
<td>
<a href="prog/automation/excel.f">excel.f</a>
<td>
<a href="prog/automation/shell.f">shell.f</a>
</table>

</html>